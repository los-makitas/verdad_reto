<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Verdad o Reto - Ultimate</title>
    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- AlpineJS -->
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"
    ></script>
    <!-- FontAwesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Google Fonts (Inter para toque moderno) -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary: #ec4899; /* Pink 500 */
        --secondary: #8b5cf6; /* Violet 500 */
        --dark-bg: #0f172a; /* Slate 900 */
      }

      body {
        font-family: "Inter", sans-serif;
        background-color: var(--dark-bg);
        overflow: hidden; /* Evita scroll en app mode */
        touch-action: manipulation;
      }

      [x-cloak] {
        display: none !important;
      }

      /* Fondo Animado Sutil */
      .blob {
        position: absolute;
        filter: blur(80px);
        z-index: 0;
        opacity: 0.4;
        animation: float 10s infinite ease-in-out;
      }
      .blob-1 {
        top: -10%;
        left: -10%;
        width: 50vw;
        height: 50vw;
        background: var(--primary);
        animation-delay: 0s;
      }
      .blob-2 {
        bottom: -10%;
        right: -10%;
        width: 60vw;
        height: 60vw;
        background: var(--secondary);
        animation-delay: 5s;
      }

      @keyframes float {
        0%,
        100% {
          transform: translate(0, 0) scale(1);
        }
        50% {
          transform: translate(20px, -20px) scale(1.1);
        }
      }

      /* Glassmorphism Classes */
      .glass {
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }

      .glass-card {
        background: rgba(15, 23, 42, 0.6);
        backdrop-filter: blur(20px);
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }

      /* Ruleta Responsiva */
      .wheel-container {
        width: 90vw;
        height: 90vw;
        max-width: 500px;
        max-height: 500px;
        position: relative;
        filter: drop-shadow(0 0 20px rgba(0, 0, 0, 0.5));
      }

      .pointer-arrow {
        position: absolute;
        top: -20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 50;
        filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.3));
      }

      /* Botón central integrado */
      .spin-btn {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 25%;
        height: 25%;
        border-radius: 50%;
        background: radial-gradient(circle at 30% 30%, #ffffff, #e2e8f0);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5),
          inset 0 -5px 10px rgba(0, 0, 0, 0.1);
        z-index: 60;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border: 4px solid rgba(255, 255, 255, 0.8);
      }

      .spin-btn:active {
        transform: translate(-50%, -50%) scale(0.95);
      }

      /* Animación de entrada */
      .slide-up {
        animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      }
      @keyframes slideUp {
        from {
          transform: translateY(100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .pop-in {
        animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      }
      @keyframes popIn {
        from {
          transform: scale(0.8);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }

      /* Scroll oculta para categorías */
      .no-scrollbar::-webkit-scrollbar {
        display: none;
      }
      .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
    </style>
  </head>
  <body
    class="text-white h-[100dvh] w-screen overflow-hidden flex flex-col items-center justify-center relative"
  >
    <!-- Alpine Logic (Mismo núcleo, nueva estructura visual) -->
    <script>
      const JSON_URL =
        "https://raw.githubusercontent.com/los-makitas/verdad_reto/refs/heads/main/database.json";

      function secureRandom(min, max) {
        const range = max - min + 1;
        const bytes = new Uint32Array(1);
        window.crypto.getRandomValues(bytes);
        return min + (bytes[0] % range);
      }

      document.addEventListener("alpine:init", () => {
        Alpine.data("gameLogic", () => ({
          phase: "loading", // loading, setup, game, spinning, choice, result
          couples: [],
          db: null,
          categories: [],

          // Form vars
          newMan: "",
          newWoman: "",
          editingId: null,

          // Game vars
          currentCategory: "",
          wheelRotation: 0,
          isSpinning: false,
          turnHistory: [],

          selectedCouple: null,
          selectedType: null, // 'verdad' or 'reto'
          currentChallengeText: "",

          // Paleta moderna y vibrante
          colors: [
            "#F43F5E", // Rose 500
            "#3B82F6", // Blue 500
            "#10B981", // Emerald 500
            "#8B5CF6", // Violet 500
            "#F59E0B", // Amber 500
            "#EC4899", // Pink 500
            "#06B6D4", // Cyan 500
            "#6366F1", // Indigo 500
          ],

          async init() {
            try {
              const response = await fetch(JSON_URL);
              if (!response.ok) throw new Error("Error cargando DB");
              this.db = await response.json();
              this.categories = Object.keys(this.db);
              if (this.categories.length > 0)
                this.currentCategory = this.categories[0];
            } catch (error) {
              console.error(error);
            }
            this.loadCouplesFromStorage();
            this.phase = "setup";
            this.$nextTick(() => this.drawWheel());
          },

          loadCouplesFromStorage() {
            const stored = localStorage.getItem("vr_couples_v2");
            if (stored) this.couples = JSON.parse(stored);
          },

          saveCouplesToStorage() {
            localStorage.setItem("vr_couples_v2", JSON.stringify(this.couples));
            this.drawWheel();
          },

          addCouple() {
            if (!this.newMan.trim() || !this.newWoman.trim()) return;
            if (this.editingId) {
              const idx = this.couples.findIndex(
                (c) => c.id === this.editingId
              );
              if (idx !== -1) {
                this.couples[idx].man = this.newMan;
                this.couples[idx].woman = this.newWoman;
              }
              this.editingId = null;
            } else {
              this.couples.push({
                id: Date.now(),
                man: this.newMan,
                woman: this.newWoman,
                color: this.colors[this.couples.length % this.colors.length],
              });
            }
            this.saveCouplesToStorage();
            this.newMan = "";
            this.newWoman = "";
          },

          editCouple(c) {
            this.newMan = c.man;
            this.newWoman = c.woman;
            this.editingId = c.id;
          },

          cancelEdit() {
            this.newMan = "";
            this.newWoman = "";
            this.editingId = null;
          },

          removeCouple(id) {
            this.couples = this.couples.filter((c) => c.id !== id);
            this.saveCouplesToStorage();
            if (this.editingId === id) this.cancelEdit();
          },

          startGame() {
            if (this.couples.length < 2) {
              // Pequeña animación de error o alerta custom
              alert("Mínimo 2 parejas para jugar");
              return;
            }
            this.turnHistory = [];
            this.phase = "game";
            this.$nextTick(() => this.drawWheel());
          },

          spinWheel() {
            if (this.isSpinning) return;
            this.isSpinning = true;
            this.phase = "spinning";

            // --- Lógica de Exclusión (Últimas 3 jugadas) ---
            let exclusionId = null;
            if (this.turnHistory.length >= 3) {
              const lastThree = this.turnHistory.slice(-3);
              if (lastThree.every((id) => id === lastThree[0])) {
                exclusionId = lastThree[0];
              }
            }

            let pool = this.couples;
            if (exclusionId) {
              pool = this.couples.filter((c) => c.id !== exclusionId);
            }
            if (pool.length === 0) pool = this.couples;

            // Ganador
            const winner = pool[secureRandom(0, pool.length - 1)];
            const winnerIndex = this.couples.findIndex(
              (c) => c.id === winner.id
            );
            this.selectedCouple = this.couples[winnerIndex];

            // Historial
            this.turnHistory.push(this.selectedCouple.id);
            if (this.turnHistory.length > 10) this.turnHistory.shift();

            // --- CÁLCULO DE GIRO CONSTANTE ---
            const total = this.couples.length;
            const segment = 360 / total;
            const targetAngle = 360 - winnerIndex * segment;
            // Offset aleatorio para que no caiga siempre en el centro del segmento
            const randomOffset =
              Math.random() * (segment * 0.8) + segment * 0.1;
            const finalTarget = targetAngle - randomOffset;

            const currentRot = this.wheelRotation;
            const currentMod = currentRot % 360;

            let distance = finalTarget - currentMod;
            if (distance <= 0) distance += 360;

            // SIEMPRE 8 vueltas rápidas + ajuste
            const fixedSpins = 8;

            this.wheelRotation = currentRot + 360 * fixedSpins + distance;

            // Esperar animación (CSS transition duration)
            setTimeout(() => {
              this.isSpinning = false;
              this.phase = "choice";
            }, 4000); // 4s para un giro rápido y enérgico
          },

          selectType(type) {
            this.selectedType = type;
            this.generateChallenge();
            this.phase = "result";
          },

          generateChallenge() {
            if (this.db && this.db[this.currentCategory]) {
              const list = this.db[this.currentCategory][this.selectedType];
              this.currentChallengeText =
                list[secureRandom(0, list.length - 1)];
            } else {
              this.currentChallengeText = "Error cargando reto.";
            }
          },

          nextTurn() {
            this.phase = "game";
            this.selectedCouple = null;
            this.selectedType = null;
          },

          returnToLobby() {
            if (confirm("¿Volver a editar parejas?")) {
              this.phase = "setup";
            }
          },

          // --- SVG Drawing Utilities ---
          polarToCartesian(centerX, centerY, radius, angleInDegrees) {
            const angleInRadians = ((angleInDegrees - 90) * Math.PI) / 180.0;
            return {
              x: centerX + radius * Math.cos(angleInRadians),
              y: centerY + radius * Math.sin(angleInRadians),
            };
          },

          describeArc(x, y, radius, startAngle, endAngle) {
            const start = this.polarToCartesian(x, y, radius, endAngle);
            const end = this.polarToCartesian(x, y, radius, startAngle);
            const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
            return [
              "M",
              start.x,
              start.y,
              "A",
              radius,
              radius,
              0,
              largeArcFlag,
              0,
              end.x,
              end.y,
              "L",
              x,
              y,
              "L",
              start.x,
              start.y,
            ].join(" ");
          },

          escapeHtml(text) {
            const map = {
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#039;",
            };
            return text.replace(/[&<>"']/g, function (m) {
              return map[m];
            });
          },

          drawWheel() {
            const svg = this.$refs.wheelSvg;
            if (!svg) return;
            svg.innerHTML = "";

            const total = this.couples.length;
            if (total === 0) return;

            const radius = 50;
            const center = 50;
            const angleStep = 360 / total;

            this.couples.forEach((couple, i) => {
              const startAngle = i * angleStep;
              const endAngle = startAngle + angleStep;

              // Segmento
              const path = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "path"
              );
              path.setAttribute(
                "d",
                this.describeArc(center, center, radius, startAngle, endAngle)
              );
              path.setAttribute("fill", couple.color);
              path.setAttribute("stroke", "#1f2937"); // Dark border
              path.setAttribute("stroke-width", "0.5");
              svg.appendChild(path);

              // Texto (Nombres)
              const midAngle = startAngle + angleStep / 2;
              // Posición del texto un poco más afuera del centro
              const textPos = this.polarToCartesian(
                center,
                center,
                radius * 0.65,
                midAngle
              );

              const text = document.createElementNS(
                "http://www.w3.org/2000/svg",
                "text"
              );
              text.setAttribute("x", textPos.x);
              text.setAttribute("y", textPos.y);
              text.setAttribute("fill", "white");
              text.setAttribute(
                "font-size",
                total > 8 ? "3" : total > 4 ? "4" : "5"
              );
              text.setAttribute("font-weight", "900");
              text.setAttribute("text-anchor", "middle");
              text.setAttribute("dominant-baseline", "middle");
              text.setAttribute(
                "transform",
                `rotate(${midAngle}, ${textPos.x}, ${textPos.y})`
              );

              // Solo mostramos iniciales si hay muchos, o nombre corto
              const label = `${couple.man} & ${couple.woman}`;
              text.textContent =
                label.length > 15 ? label.substring(0, 12) + "..." : label;

              svg.appendChild(text);
            });
          },
        }));
      });
    </script>

    <!-- Background Elements -->
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
    <div
      class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-5 z-0 pointer-events-none"
    ></div>

    <div x-data="gameLogic" class="relative z-10 w-full h-full flex flex-col">
      <!-- HEADER (Solo visible en Juego) -->
      <div
        x-show="phase !== 'setup'"
        class="absolute top-0 left-0 w-full p-4 flex justify-between items-start z-30"
        x-cloak
        x-transition
      >
        <button
          @click="returnToLobby"
          class="text-white/40 hover:text-white transition"
        >
          <i class="fas fa-chevron-left text-xl"></i>
        </button>
        <div
          class="glass px-3 py-1 rounded-full text-xs font-bold tracking-widest text-white/50 uppercase"
        >
          Edición Parejas
        </div>
      </div>

      <!-- ======================= -->
      <!-- VIEW: SETUP (LOBBY) -->
      <!-- ======================= -->
      <div
        x-show="phase === 'setup'"
        x-transition.opacity.duration.500ms
        class="flex-1 flex flex-col p-6 overflow-y-auto"
      >
        <div class="mt-8 mb-6">
          <h1
            class="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-purple-500 leading-tight"
          >
            VERDAD<br />O RETO
          </h1>
          <p class="text-white/60 text-lg mt-2">
            Agrega a los jugadores para comenzar.
          </p>
        </div>

        <!-- Listado de Parejas (Cards) -->
        <div class="flex-1 space-y-3 mb-4 overflow-y-auto pb-20 no-scrollbar">
          <template x-for="(c, i) in couples" :key="c.id">
            <div
              class="glass flex items-center justify-between p-4 rounded-2xl border-l-4"
              :style="`border-left-color: ${c.color}`"
            >
              <div>
                <div class="text-sm text-gray-400 mb-1">
                  Pareja <span x-text="i+1"></span>
                </div>
                <div class="font-bold text-lg leading-none">
                  <span class="text-white" x-text="c.man"></span>
                  <span class="text-pink-500 mx-1">&</span>
                  <span class="text-white" x-text="c.woman"></span>
                </div>
              </div>
              <div class="flex gap-3">
                <button
                  @click="editCouple(c)"
                  class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-blue-400"
                >
                  <i class="fas fa-pencil"></i>
                </button>
                <button
                  @click="removeCouple(c.id)"
                  class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-red-400"
                >
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </template>

          <div
            x-show="couples.length === 0"
            class="text-center py-10 text-white/20 italic border-2 border-dashed border-white/10 rounded-2xl"
          >
            No hay parejas aún
          </div>
        </div>

        <!-- Fixed Bottom Input Area -->
        <div class="fixed bottom-0 left-0 w-full glass-card p-4 pb-8 z-50">
          <div class="flex gap-2 mb-3">
            <input
              type="text"
              x-model="newMan"
              placeholder="Él"
              class="w-1/2 bg-black/40 border-0 rounded-xl p-4 text-white placeholder-white/30 focus:ring-2 focus:ring-pink-500 outline-none text-lg"
            />
            <input
              type="text"
              x-model="newWoman"
              placeholder="Ella"
              class="w-1/2 bg-black/40 border-0 rounded-xl p-4 text-white placeholder-white/30 focus:ring-2 focus:ring-purple-500 outline-none text-lg"
            />
          </div>
          <div class="flex gap-2 h-14">
            <button
              x-show="editingId"
              @click="cancelEdit"
              class="w-16 bg-gray-700 rounded-xl text-white font-bold"
            >
              <i class="fas fa-times"></i>
            </button>
            <button
              @click="addCouple"
              class="flex-1 bg-white text-black rounded-xl font-black text-lg uppercase tracking-wider hover:bg-gray-200 transition"
            >
              <span x-text="editingId ? 'Actualizar' : 'Agregar'"></span>
            </button>
            <button
              @click="startGame"
              :disabled="couples.length < 2"
              class="flex-1 bg-gradient-to-r from-pink-600 to-purple-600 rounded-xl font-black text-lg uppercase tracking-wider shadow-lg shadow-purple-500/30 disabled:opacity-50 disabled:shadow-none"
            >
              Jugar
            </button>
          </div>
        </div>
      </div>

      <!-- ======================= -->
      <!-- VIEW: GAME (RULETA) -->
      <!-- ======================= -->
      <div
        x-show="phase === 'game' || phase === 'spinning' || phase === 'choice'"
        x-cloak
        class="flex-1 flex flex-col items-center justify-center relative"
      >
        <!-- Selector de Categoría (Top Floating) -->
        <div
          class="absolute top-16 left-0 w-full overflow-x-auto no-scrollbar px-6 z-20 flex gap-3 justify-center"
        >
          <template x-for="(cat, index) in categories" :key="cat">
            <button
              @click="currentCategory = cat"
              class="px-5 py-2 rounded-full text-sm font-bold uppercase tracking-wider transition whitespace-nowrap border-2"
              :class="currentCategory === cat 
                ? 'bg-white text-black border-white shadow-[0_0_15px_rgba(255,255,255,0.4)]' 
                : 'bg-black/50 text-white/80 border-white/30 hover:bg-black/70 hover:border-white/50'"
              :style="`z-index: ${categories.length - index};`"
              x-text="cat"
            ></button>
          </template>
        </div>

        <!-- La Ruleta Gigante -->
        <div class="wheel-container">
          <!-- Flecha Marcadora -->
          <div class="pointer-arrow text-white text-5xl drop-shadow-xl">
            <i class="fas fa-caret-down text-[#fbbf24]"></i>
          </div>

          <!-- SVG -->
          <svg
            x-ref="wheelSvg"
            viewBox="0 0 100 100"
            class="w-full h-full rounded-full"
            :style="`transform: rotate(${wheelRotation}deg); transition: transform 4s cubic-bezier(0.15, 0.85, 0.35, 1.05);`"
          ></svg>

          <!-- Botón Central (Cap) -->
          <div @click="spinWheel" class="spin-btn group">
            <div class="text-center transition group-active:scale-90">
              <div
                x-show="!isSpinning"
                class="text-gray-900 font-black text-xl md:text-2xl uppercase tracking-tighter leading-none"
              >
                GIRAR
              </div>
              <div
                x-show="isSpinning"
                class="text-pink-600 animate-spin text-2xl"
              >
                <i class="fas fa-circle-notch"></i>
              </div>
            </div>
          </div>
        </div>

        <p
          class="absolute bottom-12 text-white/30 text-xs font-bold tracking-[0.2em] uppercase animate-pulse"
          x-show="!isSpinning"
        >
          Toca el centro para girar
        </p>
      </div>

      <!-- ======================= -->
      <!-- MODAL: ELECCIÓN -->
      <!-- ======================= -->
      <div
        x-show="phase === 'choice'"
        class="fixed inset-0 z-50 bg-black/80 backdrop-blur-xl flex flex-col items-center justify-center p-6"
        x-transition.opacity
      >
        <div class="text-center mb-10 pop-in">
          <p class="text-gray-400 text-lg uppercase tracking-widest mb-2">
            Es el turno de
          </p>
          <h2 class="text-5xl font-black text-white leading-tight">
            <span x-text="selectedCouple ? selectedCouple.man : ''"></span>
            <span class="text-pink-500">&</span><br />
            <span x-text="selectedCouple ? selectedCouple.woman : ''"></span>
          </h2>
        </div>

        <div
          class="w-full max-w-sm space-y-4 pop-in"
          style="animation-delay: 0.1s"
        >
          <button
            @click="selectType('verdad')"
            class="w-full h-24 bg-gradient-to-r from-blue-600 to-blue-400 rounded-3xl flex items-center justify-between px-8 shadow-lg shadow-blue-500/30 active:scale-95 transition transform"
          >
            <span class="text-3xl font-black italic">VERDAD</span>
            <i class="fas fa-comment-dots text-4xl text-white/80"></i>
          </button>
          <button
            @click="selectType('reto')"
            class="w-full h-24 bg-gradient-to-r from-red-600 to-pink-600 rounded-3xl flex items-center justify-between px-8 shadow-lg shadow-red-500/30 active:scale-95 transition transform"
          >
            <span class="text-3xl font-black italic">RETO</span>
            <i class="fas fa-fire text-4xl text-white/80"></i>
          </button>
        </div>
      </div>

      <!-- ======================= -->
      <!-- MODAL: RESULTADO -->
      <!-- ======================= -->
      <div
        x-show="phase === 'result'"
        class="fixed inset-0 z-50 bg-[#0f172a] flex flex-col"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="translate-y-full"
        x-transition:enter-end="translate-y-0"
      >
        <!-- Header Resultado -->
        <div class="p-8 pb-0 pt-12 text-center">
          <div
            class="inline-block px-4 py-2 rounded-full text-sm font-bold tracking-widest uppercase mb-4"
            :class="selectedType === 'verdad' ? 'bg-blue-500/20 text-blue-400' : 'bg-red-500/20 text-red-400'"
          >
            <i
              :class="selectedType === 'verdad' ? 'fas fa-comment-dots' : 'fas fa-fire'"
              class="mr-2"
            ></i>
            <span x-text="selectedType"></span>
          </div>
          <h2
            class="text-3xl font-bold text-white/50"
            x-text="currentCategory"
          ></h2>
        </div>

        <!-- Contenido del Reto -->
        <div class="flex-1 flex items-center justify-center p-8">
          <p
            class="text-3xl md:text-4xl font-black text-center leading-normal text-white drop-shadow-[0_0_15px_rgba(255,255,255,0.3)]"
            x-text="currentChallengeText"
          ></p>
        </div>

        <!-- Botón Continuar -->
        <div class="p-6 pb-12">
          <button
            @click="nextTurn"
            class="w-full bg-white text-black py-6 rounded-2xl font-black text-xl uppercase tracking-widest hover:scale-[1.02] transition shadow-2xl"
          >
            Siguiente Turno
          </button>
        </div>
      </div>
    </div>
  </body>
</html>
